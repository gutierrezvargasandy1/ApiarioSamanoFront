import { Component, OnInit } from '@angular/core';
import { ApiarioService } from '../../services/apiariosService/apiario-service';
import { MedicamentosService, MedicamentosResponse } from '../../services/almaceneService/MedicamentosService/medicamentos-service';
import { ToastService } from '../../services/toastService/toast-service';

// Interfaces actualizadas seg√∫n el servicio
interface RecetaMedicamento {
  id: number;
  receta: Receta;
  idMedicamento: number;
  medicamentoInfo: any;
}

interface Receta {
  id: number;
  descripcion: string;
  fechaDeCreacion: string;
  medicamentos: RecetaMedicamento[];
}

interface HistorialMedico {
  id: number;
  fechaAplicacion: string;
  notas: string;
}

interface Apiario {
  id: number;
  numeroApiario: number;
  ubicacion: string;
  salud: string;
  receta: Receta | null;
  historialMedico: HistorialMedico | null;
}

interface ApiarioRequest {
  numeroApiario: number;
  ubicacion: string;
  salud: string;
}

interface RecetaRequest {
  descripcion: string;
  medicamentos: MedicamentoRequest[];
}

interface MedicamentoRequest {
  id: number;
}

@Component({
  selector: 'app-apiarios',
  standalone: false,
  templateUrl: './apiarios.html',
  styleUrl: './apiarios.css'
})
export class Apiarios implements OnInit {
  // Estado de la aplicaci√≥n
  apiarios: Apiario[] = [];
  apiarioSeleccionado: Apiario | null = null;
  
  // Modales
  mostrarModalApiario: boolean = false;
  mostrarModalReceta: boolean = false;
  
  // Edici√≥n
  apiarioEditando: Apiario | null = null;
  
  // Formularios
  formApiario = {
    numeroApiario: 0,
    ubicacion: '',
    salud: ''
  };
  
  formReceta = {
    descripcion: '',
    medicamentos: [] as MedicamentoRequest[]
  };
  
  // Lista de medicamentos disponibles
  medicamentosDisponibles: MedicamentosResponse[] = [];
  cargandoMedicamentos: boolean = false;
  
  // Estado de carga
  cargando: boolean = false;

  // Modal IA
  mostrarModalSugerencias: boolean = false;
  nuevaPregunta: string = '';
  mensajesChat: any[] = [];

  sugerenciasAutomaticas = [
    {
        titulo: 'Optimizaci√≥n de Alimentaci√≥n',
        descripcion: 'Basado en la ubicaci√≥n y estado de salud, recomiendo ajustar el suplemento alimenticio.'
    },
    {
        titulo: 'Prevenci√≥n de Enfermedades',
        descripcion: 'Considera implementar un programa de monitoreo para varroa durante los pr√≥ximos 15 d√≠as.'
    },
    {
        titulo: 'Mejora de Productividad',
        descripcion: 'La ubicaci√≥n actual es favorable, pero podr√≠as aumentar la flora mel√≠fera en un 20%.'
    }
  ];

  constructor(
    private apiarioService: ApiarioService,
    private medicamentosService: MedicamentosService,
    private toastService: ToastService
  ) {}

  ngOnInit(): void {
    this.cargarApiarios();
    this.cargarMedicamentosDisponibles();
  }

  // ==================== CARGA DE MEDICAMENTOS ====================
  
  cargarMedicamentosDisponibles(): void {
    this.cargandoMedicamentos = true;
    
    this.medicamentosService.obtenerTodos().subscribe({
      next: (response: any) => {
        if (response.codigo === 200 && response.data) {
          this.medicamentosDisponibles = response.data;
          console.log('üíä Medicamentos cargados:', this.medicamentosDisponibles);
        } else {
          this.toastService.error('Error', response.descripcion || 'Error al cargar medicamentos');
        }
        this.cargandoMedicamentos = false;
      },
      error: (err: any) => {
        console.error('‚ùå Error al cargar medicamentos:', err);
        this.toastService.error('Error', 'No se pudieron cargar los medicamentos');
        this.cargandoMedicamentos = false;
      }
    });
  }

  // ==================== CARGA DE DATOS ====================
  
  cargarApiarios(): void {
    this.cargando = true;
    
    this.apiarioService.obtenerTodos().subscribe({
      next: (response: any) => {
        if (response.codigo === 200 && response.data) {
          this.apiarios = response.data;
          console.log('‚úÖ Apiarios cargados:', this.apiarios);
        } else {
          this.toastService.error('Error', response.descripcion || 'Error al cargar apiarios');
        }
        this.cargando = false;
      },
      error: (err: any) => {
        console.error('‚ùå Error al cargar apiarios:', err);
        this.toastService.error('Error', 'No se pudieron cargar los apiarios');
        this.cargando = false;
      }
    });
  }

  // ==================== SELECCI√ìN ====================
  
  seleccionarApiario(apiario: Apiario): void {
    this.apiarioSeleccionado = apiario;
    console.log('üêù Apiario seleccionado:', apiario);
  }

  // ==================== MODAL APIARIO ====================
  
  abrirModalApiario(apiario?: Apiario): void {
    if (apiario) {
      this.apiarioEditando = apiario;
      this.formApiario = {
        numeroApiario: apiario.numeroApiario,
        ubicacion: apiario.ubicacion,
        salud: apiario.salud
      };
    } else {
      this.apiarioEditando = null;
      this.formApiario = {
        numeroApiario: 0,
        ubicacion: '',
        salud: ''
      };
    }
    this.mostrarModalApiario = true;
  }

  cerrarModalApiario(): void {
    this.mostrarModalApiario = false;
    this.apiarioEditando = null;
    this.formApiario = {
      numeroApiario: 0,
      ubicacion: '',
      salud: ''
    };
  }

  guardarApiario(): void {
    if (!this.formApiario.ubicacion || !this.formApiario.salud || !this.formApiario.numeroApiario) {
      this.toastService.warning('Atenci√≥n', 'Por favor complete todos los campos');
      return;
    }

    const request: ApiarioRequest = {
      numeroApiario: this.formApiario.numeroApiario,
      ubicacion: this.formApiario.ubicacion,
      salud: this.formApiario.salud
    };

    this.cargando = true;

    if (this.apiarioEditando) {
      // Actualizar apiario existente
      this.apiarioService.modificarApiario(this.apiarioEditando.id, request).subscribe({
        next: (response: any) => {
          if (response.codigo === 200) {
            this.toastService.success('√âxito', 'Apiario actualizado correctamente');
            this.cargarApiarios();
            this.cerrarModalApiario();
          } else {
            this.toastService.error('Error', response.descripcion || 'Error al actualizar apiario');
          }
          this.cargando = false;
        },
        error: (err: any) => {
          console.error('‚ùå Error al actualizar apiario:', err);
          this.toastService.error('Error', 'No se pudo actualizar el apiario');
          this.cargando = false;
        }
      });
    } else {
      // Crear nuevo apiario
      this.apiarioService.crearApiario(request).subscribe({
        next: (response: any) => {
          if (response.codigo === 200) {
            this.toastService.success('√âxito', 'Apiario creado correctamente');
            this.cargarApiarios();
            this.cerrarModalApiario();
          } else {
            this.toastService.error('Error', response.descripcion || 'Error al crear apiario');
          }
          this.cargando = false;
        },
        error: (err: any) => {
          console.error('‚ùå Error al crear apiario:', err);
          this.toastService.error('Error', 'No se pudo crear el apiario');
          this.cargando = false;
        }
      });
    }
  }

  editarApiario(apiario: Apiario, event: Event): void {
    event.stopPropagation();
    this.abrirModalApiario(apiario);
  }

  eliminarApiario(apiario: Apiario, event: Event): void {
    event.stopPropagation();
    
    if (!confirm(`¬øEst√°s seguro de eliminar el apiario #${apiario.numeroApiario}?`)) {
      return;
    }

    this.cargando = true;
    
    this.apiarioService.eliminarApiario(apiario.id).subscribe({
      next: (response: any) => {
        if (response.codigo === 200) {
          this.apiarios = this.apiarios.filter(a => a.id !== apiario.id);
          
          if (this.apiarioSeleccionado?.id === apiario.id) {
            this.apiarioSeleccionado = null;
          }
          
          this.toastService.success('√âxito', 'Apiario eliminado correctamente');
        } else {
          this.toastService.error('Error', response.descripcion || 'Error al eliminar apiario');
        }
        this.cargando = false;
      },
      error: (err: any) => {
        console.error('‚ùå Error al eliminar apiario:', err);
        this.toastService.error('Error', 'No se pudo eliminar el apiario');
        this.cargando = false;
      }
    });
  }

  // ==================== MODAL RECETA ====================
  
  abrirModalReceta(apiario: Apiario, event: Event): void {
    event.stopPropagation();
    this.apiarioSeleccionado = apiario;
    this.formReceta = {
      descripcion: '',
      medicamentos: []
    };
    this.mostrarModalReceta = true;
    
    // Recargar medicamentos disponibles cada vez que se abre el modal
    this.cargarMedicamentosDisponibles();
  }

  cerrarModalReceta(): void {
    this.mostrarModalReceta = false;
    this.formReceta = {
      descripcion: '',
      medicamentos: []
    };
  }

  // M√©todo para agregar medicamento al formulario
  agregarMedicamento(): void {
    this.formReceta.medicamentos.push({ id: 0 });
  }

  // M√©todo para remover medicamento del formulario
  removerMedicamento(index: number): void {
    this.formReceta.medicamentos.splice(index, 1);
  }

  // M√©todo para obtener nombre del medicamento por ID
  obtenerNombreMedicamento(id: number): string {
    const medicamento = this.medicamentosDisponibles.find(m => m.id === id);
    return medicamento ? medicamento.nombre : 'Medicamento no encontrado';
  }

  guardarReceta(): void {
    if (!this.formReceta.descripcion || this.formReceta.medicamentos.length === 0) {
      this.toastService.warning('Atenci√≥n', 'Por favor complete la descripci√≥n y agregue al menos un medicamento');
      return;
    }

    // Validar que todos los medicamentos tengan ID
    const medicamentosInvalidos = this.formReceta.medicamentos.some(med => !med.id || med.id === 0);
    if (medicamentosInvalidos) {
      this.toastService.warning('Atenci√≥n', 'Todos los medicamentos deben tener un ID v√°lido');
      return;
    }

    if (!this.apiarioSeleccionado) {
      this.toastService.error('Error', 'Debe seleccionar un apiario');
      return;
    }

    const request: RecetaRequest = {
      descripcion: this.formReceta.descripcion,
      medicamentos: this.formReceta.medicamentos
    };

    this.cargando = true;

    this.apiarioService.agregarReceta(this.apiarioSeleccionado.id, request).subscribe({
      next: (response: any) => {
        if (response.codigo === 200) {
          this.toastService.success('√âxito', 'Receta agregada correctamente');
          this.cargarApiarios();
          this.cerrarModalReceta();
          
          // Actualizar apiario seleccionado
          setTimeout(() => {
            const apiarioActualizado = this.apiarios.find(a => a.id === this.apiarioSeleccionado?.id);
            if (apiarioActualizado) {
              this.apiarioSeleccionado = apiarioActualizado;
            }
          }, 100);
        } else {
          this.toastService.error('Error', response.descripcion || 'Error al agregar receta');
        }
        this.cargando = false;
      },
      error: (err: any) => {
        console.error('‚ùå Error al agregar receta:', err);
        this.toastService.error('Error', 'No se pudo agregar la receta');
        this.cargando = false;
      }
    });
  }

  eliminarReceta(apiario: Apiario): void {
    if (!confirm('¬øMarcar esta receta como cumplida?')) {
      return;
    }

    this.cargando = true;

    this.apiarioService.eliminarRecetaCumplida(apiario.id).subscribe({
      next: (response: any) => {
        if (response.codigo === 200) {
          this.toastService.success('√âxito', 'Receta marcada como cumplida y agregada al historial');
          this.cargarApiarios();
          
          // Actualizar apiario seleccionado
          setTimeout(() => {
            const apiarioActualizado = this.apiarios.find(a => a.id === apiario.id);
            if (apiarioActualizado) {
              this.apiarioSeleccionado = apiarioActualizado;
            }
          }, 100);
        } else {
          this.toastService.error('Error', response.descripcion || 'Error al eliminar receta');
        }
        this.cargando = false;
      },
      error: (err: any) => {
        console.error('‚ùå Error al eliminar receta:', err);
        this.toastService.error('Error', 'No se pudo eliminar la receta');
        this.cargando = false;
      }
    });
  }

  // ==================== UTILIDADES ====================
  
  obtenerClaseBadge(salud: string): string {
    switch (salud.toLowerCase()) {
      case 'buena':
        return 'badge-buena';
      case 'regular':
        return 'badge-regular';
      case 'cr√≠tica':
      case 'critica':
        return 'badge-critica';
      default:
        return 'badge-regular';
    }
  }

  tieneRecetaActiva(apiario: Apiario): boolean {
    return !!apiario.receta;
  }

  contarMedicamentos(apiario: Apiario): number {
    return apiario.receta?.medicamentos?.length || 0;
  }

  obtenerDescripcionReceta(apiario: Apiario): string {
    return apiario.receta?.descripcion || 'Sin receta activa';
  }

  obtenerFechaReceta(apiario: Apiario): string {
    return apiario.receta?.fechaDeCreacion || '';
  }

  // M√©todo para formatear fecha si es necesario
  formatearFecha(fecha: string): string {
    if (!fecha) return '';
    return new Date(fecha).toLocaleDateString('es-ES');
  }

  // ==================== MODAL IA ====================

  abrirModalSugerencias() {
    this.mostrarModalSugerencias = true;
  }

  cerrarModalSugerencias() {
    this.mostrarModalSugerencias = false;
    this.nuevaPregunta = '';
    this.mensajesChat = [];
  }

  enviarPregunta(event?: any) {
    if (event) {
        event.preventDefault();
    }
    
    if (!this.nuevaPregunta.trim()) return;

    // Agregar mensaje del usuario
    this.mensajesChat.push({
        texto: this.nuevaPregunta,
        tiempo: 'Ahora',
        tipo: 'usuario'
    });

    // Simular respuesta de IA
    setTimeout(() => {
        this.mensajesChat.push({
            texto: 'He analizado tu consulta sobre el apiario. Basado en los datos, te recomiendo revisar el plan de alimentaci√≥n y considerar una inspecci√≥n m√°s frecuente durante esta temporada.',
            tiempo: 'Ahora',
            tipo: 'ia'
        });
    }, 1000);

    this.nuevaPregunta = '';
  }

  // ==================== M√âTODOS AUXILIARES PARA EL TEMPLATE ====================

  // Verificar si un medicamento est√° duplicado
  esMedicamentoDuplicado(medicamentoId: number, indiceActual: number): boolean {
    if (!medicamentoId || medicamentoId === 0) return false;
    return this.formReceta.medicamentos.some((med, index) => 
      med.id === medicamentoId && index !== indiceActual
    );
  }

  // Obtener stock de un medicamento
  obtenerStockMedicamento(id: number): number | undefined {
    const medicamento = this.medicamentosDisponibles.find(m => m.id === id);
    return medicamento?.cantidad;
  }

  // Verificar si hay medicamentos duplicados en el √≠ndice actual
  tieneMedicamentoDuplicado(medicamentoId: number, indiceActual: number): boolean {
    if (!medicamentoId || medicamentoId === 0) return false;
    return this.formReceta.medicamentos.some((med, index) => 
      med.id === medicamentoId && index !== indiceActual
    );
  }

  // Verificar si hay medicamentos sin seleccionar
  tieneMedicamentosSinSeleccionar(): boolean {
    return this.formReceta.medicamentos.some(med => !med.id || med.id === 0);
  }

  // Verificar si hay medicamentos duplicados en toda la receta
  tieneMedicamentosDuplicados(): boolean {
    const ids = this.formReceta.medicamentos.map(med => med.id).filter(id => id > 0);
    return new Set(ids).size !== ids.length;
  }

  // Verificar si hay medicamentos inv√°lidos
  tieneMedicamentosInvalidos(): boolean {
    return this.tieneMedicamentosSinSeleccionar() || this.tieneMedicamentosDuplicados();
  }

  // Contar medicamentos seleccionados
  contarMedicamentosSeleccionados(): number {
    return this.formReceta.medicamentos.filter(med => med.id > 0).length;
  }

  // Obtener lista de medicamentos seleccionados
  obtenerMedicamentosSeleccionados(): MedicamentoRequest[] {
    return this.formReceta.medicamentos.filter(med => med.id > 0);
  }
}