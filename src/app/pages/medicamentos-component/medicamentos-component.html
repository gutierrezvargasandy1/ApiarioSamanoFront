<!-- Contenido principal -->
<div class="medicamentos-container">
  <!-- Header y botón agregar -->
  <div class="header">
    <h2>Gestión de Medicamentos</h2>
    <div class="actions">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="terminoBusqueda"
          (input)="onBuscarChange()"
          placeholder="Buscar medicamentos por nombre, descripción o proveedor..."
        >
        <span class="search-icon">🔍</span>
      </div>
      <button 
        (click)="abrirFormulario()"
        class="btn add"
      >
        <span class="material-icons">add</span>
        Agregar Medicamento
      </button>
    </div>
  </div>

  <!-- Loading state -->
  <div *ngIf="cargando" class="loading">
    <div class="spinner"></div>
    <p>Cargando medicamentos...</p>
  </div>

  <!-- Catálogo de medicamentos -->
  <div *ngIf="!cargando" class="catalogo">
    <div 
      *ngFor="let medicamento of filtrarMedicamentos(); trackBy: trackByMedicamentoId"
      class="card fade-in"
    >
<div class="medicamento-media">
  <img
    *ngIf="medicamento.foto"
    [src]="'data:image/jpeg;base64,' + medicamento.foto"
    alt="{{ medicamento.nombre }}"
    class="medicamento-thumb"
  >
  <div 
    *ngIf="!medicamento.foto"
    class="medicamento-placeholder"
  >
    💊
  </div>
</div>
      <div class="card-content">
        <h3>{{ medicamento.nombre }}</h3>
        <div class="card-info">
          <strong>Descripción:</strong>
          <span class="card-info-value">{{ medicamento.descripcion }}</span>
        </div>
        <div class="card-info">
          <strong>Cantidad:</strong>
          <span class="card-info-value">{{ medicamento.cantidad }}</span>
        </div>
        <div class="card-info">
          <strong>Proveedor:</strong>
          <span class="card-info-value">{{ obtenerNombreProveedor(medicamento) }}</span>
        </div>
      </div>
      <div class="card-actions">
        <button
          (click)="editarMedicamento(medicamento)"
          class="btn edit"
        >
          <span class="material-icons">edit</span>
          Editar
        </button>
        <button
          (click)="abrirModalConfirmacion(medicamento)"
          class="btn delete"
        >
          <span class="material-icons">delete</span>
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <!-- Estado vacío -->
  <div *ngIf="filtrarMedicamentos().length === 0 && !cargando" class="empty-state">
    <div class="empty-state-icon">💊</div>
    <h3>
      {{ terminoBusqueda ? 'No se encontraron medicamentos' : 'No hay medicamentos registrados' }}
    </h3>
    <p>
      {{ terminoBusqueda ? 'Intenta con otros términos de búsqueda' : 'Comienza agregando tu primer medicamento' }}
    </p>
    <button 
      (click)="abrirFormulario()"
      class="btn add"
    >
      <span class="material-icons">add</span>
      Agregar Primer Medicamento
    </button>
  </div>
</div>

<!-- Modal de formulario -->
<div *ngIf="mostrarFormulario" class="modal">
  <div class="modal-content">
    <h3>
      {{ editando ? 'Editar Medicamento' : 'Nuevo Medicamento' }}
    </h3>

    <!-- Formulario -->
    <form (ngSubmit)="guardarMedicamento()">
      <!-- Nombre -->
      <div>
        <label>
          Nombre del Medicamento *
        </label>
        <input
          type="text"
          [(ngModel)]="medicamentoSeleccionado.nombre"
          name="nombre"
          required
          placeholder="Ingrese el nombre del medicamento"
        >
      </div>

      <!-- Descripción -->
      <div>
        <label>
          Descripción *
        </label>
        <textarea
          [(ngModel)]="medicamentoSeleccionado.descripcion"
          name="descripcion"
          required
          rows="3"
          placeholder="Ingrese la descripción del medicamento"
        ></textarea>
      </div>

      <!-- Cantidad -->
        <div>
        <label>
          Cantidad *
        </label>
        <input
          type="text"
          [(ngModel)]="medicamentoSeleccionado.cantidad"
          name="cantidad"
          required
          placeholder="Ingrese la cantidad (solo números)"
          (keypress)="soloNumeros($event)"
          (input)="validarCantidad()"
          (blur)="formatearCantidad()"
          class="cantidad-input"
        >
        <div *ngIf="mostrarErrorCantidad" class="error-message">
          ⚠️ Por favor, ingresa solo números válidos
        </div>
      </div>

      <!-- Almacén -->
      <div>
        <label>
          Almacén *
        </label>
        <select
          [(ngModel)]="medicamentoSeleccionado.idAlmacen"
          name="idAlmacen"
          required
        >
          <option value="">Seleccione un almacén</option>
          <option *ngFor="let almacen of almacenes" [value]="almacen.id">
            {{ almacen.ubicacion || 'Almacén ' + almacen.id }}
          </option>
        </select>
      </div>

      <!-- Proveedor -->
      <div>
        <label>
          Proveedor *
        </label>
        <select
          [(ngModel)]="medicamentoSeleccionado.idProveedor"
          name="idProveedor"
          required
        >
          <option value="">Seleccione un proveedor</option>
          <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
            {{ proveedor.nombreEmpresa }}
          </option>
        </select>
      </div>

      <!-- Foto - Input para subir archivo (SOLO UNA FOTO) -->
      <div>
        <label>
          Fotografía del Medicamento
        </label>
        <div class="file-upload-container">
          <input
            type="file"
            (change)="onFileSelected($event)"
            accept="image/*"
            class="file-input"
            id="fotoInput"
            single
          >
          <label for="fotoInput" class="file-upload-label">
            <span class="material-icons">cloud_upload</span>
            <span class="file-upload-text">
              {{ medicamentoSeleccionado.foto ? 'Cambiar imagen' : 'Seleccionar imagen' }}
            </span>
          </label>
          
          <!-- Vista previa de la imagen CENTRADA -->
          <div *ngIf="medicamentoSeleccionado.foto" class="image-preview-container">
            <div class="image-preview">
             <img [src]="fotoParaVistaPrevia" alt="Vista previa" class="preview-image">              <button type="button" (click)="removeImage()" class="remove-image-btn">
                <span class="material-icons">close</span>
              </button>
            </div>
          </div>
          
          <!-- Información del archivo -->
          <div *ngIf="selectedFileName" class="file-info">
            <span class="material-icons">image</span>
            {{ selectedFileName }}
            <span class="file-size" *ngIf="selectedFileSize">({{ selectedFileSize }})</span>
          </div>
        </div>
        <p class="file-help-text">
          Formatos aceptados: JPG, PNG, GIF. Tamaño máximo: 5MB. Solo se permite una imagen.
        </p>
      </div>

      <!-- Botones -->
      <div class="modal-actions">
        <button
          type="button"
          (click)="cerrarFormulario()"
          class="btn cancel"
        >
          <span class="material-icons">close</span>
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="guardando"
          class="btn save"
        >
          <span *ngIf="guardando" class="spinner-small"></span>
          <span *ngIf="!guardando" class="material-icons">{{ editando ? 'update' : 'save' }}</span>
          {{ guardando ? 'Guardando...' : (editando ? 'Actualizar' : 'Crear') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div *ngIf="mostrarModalConfirmacion" class="modal">
  <div class="modal-content confirmacion-modal">
    <div class="confirmacion-icon">⚠️</div>
    <h3>Confirmar Eliminación</h3>
    
    <div class="confirmacion-info">
      <div class="medicamento-media">
  <img
    *ngIf="medicamentoAEliminar?.foto"
    [src]="'data:image/jpeg;base64,' + medicamentoAEliminar?.foto"
    alt="{{ medicamentoAEliminar?.nombre }}"
    class="medicamento-thumb"
  >
  <div 
    *ngIf="!medicamentoAEliminar?.foto"
    class="medicamento-placeholder"
  >
   
  </div>
</div>

      <div class="medicamento-nombre">{{ medicamentoAEliminar?.nombre }}</div>
      
      <div class="medicamento-detalle">
        <strong>Descripción:</strong>
        <span>{{ medicamentoAEliminar?.descripcion }}</span>
      </div>
      <div class="medicamento-detalle">
        <strong>Cantidad:</strong>
        <span>{{ medicamentoAEliminar?.cantidad }}</span>
      </div>
      <div class="medicamento-detalle">
        <strong>Proveedor:</strong>
        <span>{{ medicamentoAEliminar ? obtenerNombreProveedor(medicamentoAEliminar) : '' }}</span>
      </div>
    </div>

    <div class="advertencia">
      <span class="material-icons">warning</span>
      <p>
        ¿Estás seguro de que deseas eliminar este medicamento? 
        Esta acción no se puede deshacer y se perderán todos los datos asociados.
      </p>
    </div>

    <div class="confirmacion-actions">
      <button
        (click)="cerrarModalConfirmacion()"
        class="btn cancel"
      >
        <span class="material-icons">close</span>
        Cancelar
      </button>
      <button
        (click)="confirmarEliminacion()"
        [disabled]="eliminando"
        class="btn delete-confirm"
      >
        <span *ngIf="eliminando" class="spinner-small"></span>
        <span *ngIf="!eliminando" class="material-icons">delete</span>
        {{ eliminando ? 'Eliminando...' : 'Eliminar' }}
      </button>
    </div>
  </div>
</div>